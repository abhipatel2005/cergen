<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Generator Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 24px 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.875rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            width: 32px;
            height: 32px;
            background: #3b82f6;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .header p {
            color: #64748b;
            font-size: 0.875rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .card-icon {
            width: 24px;
            height: 24px;
            background: #f1f5f9;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #475569;
            font-size: 14px;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
        }

        .form-section {
            margin-bottom: 32px;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: white;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            background: #fafafa;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .file-upload-area:hover {
            border-color: #3b82f6;
            background: #f8faff;
        }

        .file-upload-area.has-file {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .file-input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            background: #f1f5f9;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            font-size: 20px;
        }

        .upload-text {
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }

        .upload-hint {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .template-tabs {
            display: flex;
            background: #f1f5f9;
            border-radius: 6px;
            padding: 4px;
            margin-bottom: 16px;
        }

        .template-tab {
            flex: 1;
            padding: 8px 16px;
            border: none;
            background: none;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-tab.active {
            background: white;
            color: #1e293b;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .template-card {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .template-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .template-card.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .template-preview {
            height: 120px;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: #64748b;
        }

        .template-info {
            padding: 12px;
        }

        .template-title {
            font-weight: 500;
            font-size: 0.875rem;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .template-desc {
            font-size: 0.75rem;
            color: #64748b;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border: 1px solid transparent;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .btn-primary:hover {
            background: #2563eb;
            border-color: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border-color: #6b7280;
        }

        .btn-outline {
            background: white;
            color: #374151;
            border-color: #d1d5db;
        }

        .btn-outline:hover {
            background: #f9fafb;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-panel {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 16px;
        }

        .status-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            font-size: 0.875rem;
            color: #374151;
        }

        .status-value {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-success {
            color: #10b981;
        }

        .status-error {
            color: #ef4444;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8, #3b82f6);
            background-size: 200% 100%;
            width: 0%;
            transition: width 0.5s ease;
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .loading-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .loading-subtitle {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 20px;
        }

        .loading-progress {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .loading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8, #3b82f6);
            background-size: 200% 100%;
            width: 0%;
            transition: width 0.5s ease;
            animation: shimmer 2s infinite;
        }

        .loading-steps {
            text-align: left;
            margin-top: 20px;
        }

        .loading-step {
            display: flex;
            align-items: center;
            padding: 8px 0;
            font-size: 0.875rem;
            color: #64748b;
        }

        .loading-step.active {
            color: #3b82f6;
            font-weight: 500;
        }

        .loading-step.completed {
            color: #10b981;
        }

        .loading-step-icon {
            width: 16px;
            height: 16px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 24px;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            margin: auto;
            position: relative;
            top: 50%;
            transform: translateY(-50%);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1e293b;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6b7280;
            padding: 4px;
        }

        .modal-body {
            padding: 24px;
        }

        .nav-tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }

        .nav-tab {
            padding: 12px 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            border-left: 4px solid;
            font-size: 0.875rem;
        }

        .alert-info {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .alert-success {
            background: #f0fdf4;
            border-color: #10b981;
            color: #065f46;
        }

        .alert-warning {
            background: #fffbeb;
            border-color: #f59e0b;
            color: #92400e;
        }

        .alert-error {
            background: #fef2f2;
            border-color: #ef4444;
            color: #991b1b;
        }

        .alert-warning {
            background: #fffbeb;
            border-color: #f59e0b;
            color: #92400e;
        }

        .certificate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            min-height: 70px;
        }

        .certificate-item.remaining-certificates {
            background: #f0f9ff;
            border-color: #0ea5e9;
        }

        .certificate-info {
            flex: 1;
            min-width: 0;
            /* Allow shrinking */
            margin-right: 16px;
        }

        .certificate-name {
            font-weight: 500;
            color: #1e293b;
            font-size: 0.95rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        .certificate-status {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 2px;
        }

        .remaining-certificates .certificate-name {
            color: #0369a1;
            font-weight: 600;
        }

        .remaining-certificates .certificate-status {
            color: #0284c7;
        }

        .field-mapping-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .field-mapping-item.mapped {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }

        .field-mapping-checkbox {
            margin-right: 12px;
        }

        .field-mapping-info {
            flex: 1;
            min-width: 0;
        }

        .field-mapping-placeholder {
            font-weight: 600;
            color: #1e293b;
            font-family: 'Courier New', monospace;
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.875rem;
        }

        .field-mapping-description {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 4px;
        }

        .field-mapping-select {
            min-width: 200px;
            margin-left: 16px;
        }

        .field-mapping-preview {
            margin-left: 12px;
            padding: 4px 8px;
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 4px;
            font-size: 0.75rem;
            color: #1e40af;
        }

        .placeholder-detected {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .placeholder-count {
            font-weight: 600;
            color: #92400e;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .template-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <div class="header">
            <h1>
                <div class="header-icon">
                    <i class="fas fa-certificate"></i>
                </div>
                Certificate Generator
            </h1>
            <p>Professional certificate generation and delivery platform</p>
        </div>

        <div class="main-content">
            <!-- Main Configuration Panel -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="card-title">Configuration</div>
                </div>

                <form id="certificateForm">
                    <!-- Data Source Section -->
                    <div class="form-section">
                        <div class="section-title">Data Source</div>
                        <div class="form-group">
                            <label class="form-label">Excel File</label>
                            <div class="file-upload-area" id="excelUpload">
                                <input type="file" id="excelFile" name="excel" accept=".xlsx,.xls" class="file-input"
                                    required>
                                <div class="upload-icon">
                                    <i class="fas fa-table"></i>
                                </div>
                                <div class="upload-text">Select Excel file</div>
                                <div class="upload-hint">Must contain 'name' and 'email' columns</div>
                            </div>
                        </div>
                    </div>

                    <!-- Template Selection Section -->
                    <div class="form-section">
                        <div class="section-title">Template Selection</div>
                        <div class="template-tabs">
                            <button type="button" class="template-tab active" data-tab="upload">Upload Template</button>
                            <button type="button" class="template-tab" data-tab="drive">Google Drive Templates</button>
                        </div>

                        <!-- Upload Template Tab -->
                        <div class="tab-content active" id="upload-tab">
                            <div class="form-group">
                                <label class="form-label">Template File</label>
                                <div class="file-upload-area" id="templateUpload">
                                    <input type="file" id="templateFile" name="template" accept=".pdf,.pptx"
                                        class="file-input">
                                    <div class="upload-icon">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div class="upload-text">Select template file</div>
                                    <div class="upload-hint">Supports .pptx (recommended) and .pdf files</div>
                                </div>
                            </div>
                        </div>

                        <!-- Google Drive Templates Tab -->
                        <div class="tab-content" id="drive-tab">
                            <div class="alert alert-info">
                                <strong>Google Drive Integration</strong><br>
                                Templates are fetched from a shared Google Drive folder. Upload your PPTX/PDF templates
                                to the configured Drive folder.
                            </div>

                            <div style="margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                                <button type="button" class="btn btn-outline" onclick="refreshDriveTemplates()">
                                    <i class="fas fa-sync-alt"></i>
                                    Refresh Templates
                                </button>
                                <button type="button" class="btn btn-outline" onclick="configureDriveAccess()">
                                    <i class="fas fa-cog"></i>
                                    Configure Drive Access
                                </button>
                                <button type="button" class="btn btn-outline" onclick="openDriveFolder()"
                                    target="_blank">
                                    <i class="fas fa-external-link-alt"></i>
                                    Open Drive Folder
                                </button>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Template Category</label>
                                <select class="form-select" id="templateCategory" onchange="loadDriveTemplates()">
                                    <option value="">All Templates</option>
                                    <option value="professional">Professional</option>
                                    <option value="academic">Academic</option>
                                    <option value="corporate">Corporate</option>
                                    <option value="creative">Creative</option>
                                </select>
                            </div>

                            <div class="template-grid" id="driveTemplates">
                                <div class="template-loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>Loading Google Drive templates...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Certificate Details Section -->
                    <div class="form-section" id="certificateDetails" style="display: none;">
                        <div class="section-title">Certificate Details</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label class="form-label">Course Name</label>
                                <input type="text" id="courseField" class="form-input"
                                    placeholder="e.g., Web Development">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Instructor</label>
                                <input type="text" id="instructorField" class="form-input"
                                    placeholder="e.g., John Smith">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Organization</label>
                                <input type="text" id="organizationField" class="form-input"
                                    placeholder="e.g., Tech Academy">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="date" id="dateField" class="form-input">
                            </div>
                        </div>
                    </div>

                    <!-- Smart Field Mapping Section -->
                    <div class="form-section" id="fieldMappingSection"
                        style="display: block; border: 2px solid #3b82f6; background: #f0f9ff;">
                        <div class="section-title">Smart Field Mapping</div>
                        <div class="alert alert-info">
                            <strong>Automatic Field Detection</strong><br>
                            We found placeholders in your template. Map them to Excel columns for automatic population.
                        </div>
                        <div id="fieldMappingContainer">
                            <!-- Dynamic mapping fields will be inserted here -->
                            <div style="padding: 20px; text-align: center; color: #64748b;">
                                <p><strong>Smart Field Mapping Section</strong></p>
                                <p>This section will show placeholder mappings when you upload both Excel and PPTX
                                    files.</p>
                                <p>Click "Test Mapping" button to see a demo, or upload your files to see real mappings.
                                </p>
                            </div>
                        </div>
                        <div style="margin-top: 16px;">
                            <button type="button" class="btn btn-outline" onclick="analyzeTemplate()">
                                <i class="fas fa-search"></i>
                                Re-analyze Template
                            </button>
                            <button type="button" class="btn btn-outline" onclick="previewMapping()">
                                <i class="fas fa-eye"></i>
                                Preview Mapping
                            </button>
                        </div>
                    </div>

                    <!-- Selection Status -->
                    <div class="form-section">
                        <div class="section-title">Selection Status</div>
                        <div class="status-panel">
                            <div class="status-item">
                                <span class="status-label">Excel File</span>
                                <span class="status-value" id="excelStatus">Not selected</span>
                            </div>
                            <div class="status-item">
                                <span class="status-label">Template</span>
                                <span class="status-value" id="templateStatus">Not selected</span>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button type="submit" class="btn btn-primary" id="generateBtn" style="flex: 1;">
                            <i class="fas fa-play"></i>
                            Generate Certificates
                        </button>
                        <button type="button" class="btn btn-outline" onclick="openEmailConfig()">
                            <i class="fas fa-envelope"></i>
                            Email Setup
                        </button>
                        <button type="button" class="btn btn-outline" onclick="debugFiles()"
                            style="font-size: 0.75rem;">
                            Debug
                        </button>
                        <button type="button" class="btn btn-outline" onclick="createTestData()"
                            style="font-size: 0.75rem;">
                            Test Data
                        </button>
                        <button type="button" class="btn btn-outline" onclick="testFieldMapping()"
                            style="font-size: 0.75rem;">
                            Test Mapping
                        </button>
                    </div>
                </form>
            </div>

            <!-- Status & Progress Panel -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="card-title">Status</div>
                </div>

                <div class="status-panel" id="systemStatus">
                    <div class="status-item">
                        <span class="status-label">Email Service</span>
                        <span class="status-value status-error" id="emailStatus">Not configured</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">PPTX Support</span>
                        <span class="status-value status-error" id="pptxStatus">Checking...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Google Drive</span>
                        <span class="status-value status-error" id="driveStatus">Not configured</span>
                    </div>
                </div>

                <div id="progressSection" style="display: none; margin-top: 20px;">
                    <div class="section-title">Progress</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div style="font-size: 0.875rem; color: #64748b; margin-top: 8px;" id="progressText">Ready</div>
                </div>

                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>Quick Start:</strong><br>
                    1. Upload Excel file with recipient data<br>
                    2. Select or upload a certificate template<br>
                    3. Configure email settings (optional)<br>
                    4. Generate and deliver certificates
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="card" id="resultsSection" style="display: none; margin-bottom: 24px;">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-certificate"></i>
                </div>
                <div class="card-title">Generated Certificates</div>
            </div>

            <div id="certificatesList"></div>

            <div class="alert alert-success" id="emailAvailable" style="display: none; margin-top: 16px;">
                <strong>Email Delivery Available</strong><br>
                Email addresses detected in your Excel file. You can send certificates directly to recipients.
                <div style="margin-top: 12px;">
                    <button type="button" class="btn btn-primary" onclick="openEmailModal()">
                        <i class="fas fa-paper-plane"></i>
                        Send Certificates via Email
                    </button>
                </div>
            </div>

            <!-- Always visible email actions -->
            <div
                style="margin-top: 16px; padding: 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;">
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button type="button" class="btn btn-outline" onclick="openEmailModal()" id="emailModalBtn">
                        <i class="fas fa-envelope"></i>
                        Email Certificates
                    </button>
                    <button type="button" class="btn btn-outline" onclick="openEmailConfig()">
                        <i class="fas fa-cog"></i>
                        Email Settings
                    </button>
                    <span style="font-size: 0.875rem; color: #64748b;">Configure email delivery for generated
                        certificates</span>
                </div>
            </div>
        </div>

        <!-- Email Configuration Modal -->
        <div class="modal" id="emailModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Email Configuration</div>
                    <button class="modal-close" onclick="closeEmailModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="nav-tabs">
                        <button type="button" class="nav-tab active" data-tab="config">Email Setup</button>
                        <button type="button" class="nav-tab" data-tab="compose">Compose Message</button>
                        <button type="button" class="nav-tab" data-tab="recipients">Recipients</button>
                    </div>

                    <div class="tab-content active" id="config-tab">
                        <div class="alert alert-warning">
                            <strong>Gmail Setup Instructions:</strong><br>
                            1. Enable 2-Factor Authentication on your Gmail account<br>
                            2. Generate App Password: <a href="https://myaccount.google.com/apppasswords"
                                target="_blank">myaccount.google.com/apppasswords</a><br>
                            3. Use the 16-character App Password below
                        </div>

                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" id="emailUser" class="form-input" placeholder="your-email@gmail.com">
                        </div>

                        <div class="form-group">
                            <label class="form-label">App Password</label>
                            <input type="password" id="emailPass" class="form-input"
                                placeholder="16-character App Password">
                        </div>

                        <button type="button" class="btn btn-primary" onclick="configureEmail()" id="configEmailBtn">
                            <i class="fas fa-check"></i>
                            Configure & Test Email
                        </button>

                        <div id="emailTestResult" style="margin-top: 16px;"></div>
                    </div>

                    <div class="tab-content" id="compose-tab">
                        <div class="form-group">
                            <label class="form-label">Email Subject</label>
                            <input type="text" id="emailSubject" class="form-input"
                                value="🎓 Your Certificate is Ready!">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Email Template</label>
                            <select id="emailTemplate" class="form-select" onchange="loadEmailTemplate()">
                                <option value="custom">Custom Message</option>
                                <option value="completion">Completion Template</option>
                                <option value="achievement">Achievement Template</option>
                                <option value="professional">Professional Template</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Message Content</label>
                            <textarea id="emailMessage" class="form-input" rows="6"
                                placeholder="Dear {{name}}, Congratulations on completing the course...">Dear {{name}},

Congratulations! You have successfully completed the {{course}} course.

We are pleased to present you with your Certificate of Completion. This certificate recognizes your dedication and achievement in mastering the course material.

Your certificate is attached to this email. Please save it for your records.

Best regards,
{{organization}} Team</textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Sender Name</label>
                            <input type="text" id="senderName" class="form-input" placeholder="Certificate Authority">
                        </div>

                        <div class="alert alert-info">
                            <strong>Available Placeholders:</strong><br>
                            <code>{{name}}</code> - Recipient's name | <code>{{course}}</code> - Course name |
                            <code>{{date}}</code> - Date | <code>{{organization}}</code> - Organization |
                            <code>{{instructor}}</code> - Instructor name
                        </div>
                    </div>

                    <div class="tab-content" id="recipients-tab">
                        <div id="recipientsList"></div>

                        <div style="margin-top: 20px;">
                            <button type="button" class="btn btn-primary" onclick="sendEmails()" id="sendEmailBtn">
                                <i class="fas fa-paper-plane"></i> Send Certificates to All Recipients
                            </button>
                        </div>

                        <div id="emailResults" style="margin-top: 20px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Configuration Modal -->
        <div class="modal" id="emailConfigModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Email Configuration</div>
                    <button class="modal-close" onclick="closeEmailConfig()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Email Service Setup</strong><br>
                        Configure your email service to enable certificate delivery functionality.
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email Service Provider</label>
                        <select class="form-select" id="emailProvider">
                            <option value="gmail">Gmail</option>
                            <option value="outlook">Outlook</option>
                            <option value="smtp">Custom SMTP</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" id="configEmailUser" class="form-input" placeholder="your-email@gmail.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Password / App Password</label>
                        <input type="password" id="configEmailPass" class="form-input"
                            placeholder="App Password (recommended)">
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button type="button" class="btn btn-primary" onclick="saveEmailConfig()" style="flex: 1;">
                            <i class="fas fa-save"></i>
                            Save Configuration
                        </button>
                        <button type="button" class="btn btn-outline" onclick="testEmailConfig()">
                            <i class="fas fa-vial"></i>
                            Test
                        </button>
                    </div>

                    <div id="emailConfigResult" style="margin-top: 16px;"></div>
                </div>
            </div>
        </div>

        <!-- Google Drive Configuration Modal -->
        <div class="modal" id="driveConfigModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Google Drive Configuration</div>
                    <button class="modal-close" onclick="closeDriveConfig()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Google Drive Setup Instructions:</strong><br>
                        1. Go to <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a><br>
                        2. Create a project and enable Google Drive API<br>
                        3. Go to "IAM & Admin" → "Service Accounts" → "Create Service Account"<br>
                        4. Download the JSON key file<br>
                        5. Create a folder in Google Drive for templates<br>
                        6. Share the folder with the service account email (from JSON file)<br>
                        7. Paste the entire JSON file content below
                    </div>

                    <div class="form-group">
                        <label class="form-label">Service Account Email</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="email" id="driveServiceEmail" class="form-input" style="flex: 1;"
                                placeholder="service-account@project.iam.gserviceaccount.com">
                            <button type="button" class="btn btn-outline" onclick="extractEmailFromJson()"
                                style="white-space: nowrap;">
                                <i class="fas fa-magic"></i>
                                Extract from JSON
                            </button>
                        </div>
                        <div style="font-size: 0.875rem; color: #64748b; margin-top: 4px;">
                            This will be auto-filled when you paste the JSON below, or click "Extract from JSON"
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Service Account JSON</label>
                        <textarea id="drivePrivateKey" class="form-input" rows="6"
                            placeholder="Paste your entire service account JSON file content here..."></textarea>
                        <div style="font-size: 0.875rem; color: #64748b; margin-top: 4px;">
                            Paste the entire JSON file content from Google Cloud Console. The system will extract the
                            required fields automatically.
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Template Folder ID</label>
                        <input type="text" id="driveFolderId" class="form-input"
                            placeholder="Google Drive folder ID containing templates">
                        <div style="font-size: 0.875rem; color: #64748b; margin-top: 4px;">
                            Find this in the Drive folder URL: drive.google.com/drive/folders/<strong>FOLDER_ID</strong>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button type="button" class="btn btn-primary" onclick="saveDriveConfig()" style="flex: 1;">
                            <i class="fas fa-save"></i>
                            Save Configuration
                        </button>
                        <button type="button" class="btn btn-outline" onclick="testDriveConnection()">
                            <i class="fas fa-vial"></i>
                            Test Connection
                        </button>
                    </div>

                    <div id="driveConfigResult" style="margin-top: 16px;"></div>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <div class="loading-title" id="loadingTitle">Generating Certificates</div>
                <div class="loading-subtitle" id="loadingSubtitle">Please wait while we process your request...</div>

                <div class="loading-progress">
                    <div class="loading-progress-fill" id="loadingProgressFill"></div>
                </div>
                <div style="font-size: 0.875rem; color: #64748b; margin-bottom: 20px;" id="loadingProgressText">0%</div>

                <div class="loading-steps">
                    <div class="loading-step" id="step1">
                        <div class="loading-step-icon">
                            <i class="fas fa-upload"></i>
                        </div>
                        <span>Uploading files...</span>
                    </div>
                    <div class="loading-step" id="step2">
                        <div class="loading-step-icon">
                            <i class="fas fa-table"></i>
                        </div>
                        <span>Processing Excel data...</span>
                    </div>
                    <div class="loading-step" id="step3">
                        <div class="loading-step-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <span>Preparing template...</span>
                    </div>
                    <div class="loading-step" id="step4">
                        <div class="loading-step-icon">
                            <i class="fas fa-magic"></i>
                        </div>
                        <span>Generating certificates...</span>
                    </div>
                    <div class="loading-step" id="step5">
                        <div class="loading-step-icon">
                            <i class="fas fa-check"></i>
                        </div>
                        <span>Finalizing...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentBatchData = null;
        let selectedDriveTemplate = null;
        let selectedExcelFile = null;
        let selectedTemplateFile = null;
        let detectedPlaceholders = [];
        let excelColumns = [];
        let fieldMappings = {};

        // Initialize variables
        console.log('Initializing global variables...');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded, initializing...');
            initializeEventListeners();
            checkSystemStatus();
            loadDriveTemplates();
        });

        function initializeEventListeners() {
            console.log('Initializing event listeners...');

            // Template tab switching
            document.querySelectorAll('.template-tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    switchTemplateTab(this.dataset.tab);
                });
            });

            // Modal tab switching
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    switchModalTab(this.dataset.tab);
                });
            });

            // File input handlers
            const excelInput = document.getElementById('excelFile');
            const templateInput = document.getElementById('templateFile');

            if (excelInput) {
                console.log('Attaching Excel file handler');
                excelInput.addEventListener('change', handleExcelFile);
            } else {
                console.error('Excel input not found!');
            }

            if (templateInput) {
                console.log('Attaching Template file handler');
                templateInput.addEventListener('change', handleTemplateFile);
            } else {
                console.error('Template input not found!');
            }

            // Form submission
            const form = document.getElementById('certificateForm');
            if (form) {
                console.log('Attaching form submit handler');
                form.addEventListener('submit', handleFormSubmit);
            } else {
                console.error('Form not found!');
            }

            // Modal close handlers
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            });
        }

        function switchTemplateTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.template-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        function switchModalTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        function handleExcelFile(event) {
            const file = event.target.files[0];

            if (file) {
                // Store file globally
                selectedExcelFile = file;

                // Update visual feedback without replacing the input
                const uploadArea = document.getElementById('excelUpload');
                const uploadIcon = uploadArea.querySelector('.upload-icon');
                const uploadText = uploadArea.querySelector('.upload-text');
                const uploadHint = uploadArea.querySelector('.upload-hint');

                uploadArea.classList.add('has-file');
                uploadIcon.style.background = '#10b981';
                uploadIcon.style.color = 'white';
                uploadIcon.innerHTML = '<i class="fas fa-check"></i>';
                uploadText.style.color = '#10b981';
                uploadText.textContent = file.name;
                uploadHint.textContent = 'Excel file selected successfully';

                // Update status indicator
                document.getElementById('excelStatus').textContent = file.name;
                document.getElementById('excelStatus').className = 'status-value status-success';

                // Extract Excel columns for field mapping
                extractExcelColumns(file);

                console.log('Excel file selected:', file.name, selectedExcelFile);
            }
        }

        function handleTemplateFile(event) {
            const file = event.target.files[0];

            if (file) {
                // Store file globally
                selectedTemplateFile = file;

                // Update visual feedback without replacing the input
                const uploadArea = document.getElementById('templateUpload');
                const uploadIcon = uploadArea.querySelector('.upload-icon');
                const uploadText = uploadArea.querySelector('.upload-text');
                const uploadHint = uploadArea.querySelector('.upload-hint');

                const fileType = file.name.toLowerCase().endsWith('.pptx') ? 'PowerPoint' : 'PDF';

                uploadArea.classList.add('has-file');
                uploadIcon.style.background = '#10b981';
                uploadIcon.style.color = 'white';
                uploadIcon.innerHTML = '<i class="fas fa-check"></i>';
                uploadText.style.color = '#10b981';
                uploadText.textContent = file.name;
                uploadHint.textContent = `${fileType} template selected`;

                // Show additional fields for PPTX
                if (file.name.toLowerCase().endsWith('.pptx')) {
                    document.getElementById('certificateDetails').style.display = 'block';
                    // Analyze PPTX template for placeholders
                    console.log('Analyzing PPTX template for placeholders...');
                    analyzeTemplateFile(file);
                }

                // Clear Drive selection if any
                selectedDriveTemplate = null;
                document.querySelectorAll('.template-card').forEach(card => {
                    card.classList.remove('selected');
                });

                // Update status indicator
                document.getElementById('templateStatus').textContent = `${fileType}: ${file.name}`;
                document.getElementById('templateStatus').className = 'status-value status-success';

                console.log('Template file selected:', file.name, selectedTemplateFile);
            }
        }

        async function loadDriveTemplates() {
            const category = document.getElementById('templateCategory').value;
            const templatesGrid = document.getElementById('driveTemplates');

            templatesGrid.innerHTML = '<div class="template-loading"><i class="fas fa-spinner fa-spin"></i><span>Loading Google Drive templates...</span></div>';

            try {
                const response = await fetch(`/drive/templates?category=${category}`);
                const result = await response.json();

                if (result.success && result.templates.length > 0) {
                    let html = '';
                    result.templates.forEach(template => {
                        const fileIcon = template.mimeType.includes('powerpoint') || template.name.endsWith('.pptx') ? 'fa-file-powerpoint' : 'fa-file-pdf';
                        const fileType = template.mimeType.includes('powerpoint') || template.name.endsWith('.pptx') ? 'PPTX' : 'PDF';

                        html += `
                            <div class="template-card" onclick="selectDriveTemplate('${template.id}', '${template.name}')">
                                <div class="template-preview">
                                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8fafc;">
                                        <i class="fas ${fileIcon}" style="font-size: 3rem; color: #64748b;"></i>
                                    </div>
                                </div>
                                <div class="template-info">
                                    <div class="template-title">${template.name}</div>
                                    <div class="template-desc">${fileType} • ${(template.size / 1024 / 1024).toFixed(1)} MB</div>
                                </div>
                            </div>
                        `;
                    });
                    templatesGrid.innerHTML = html;
                } else if (result.error && result.error.includes('not configured')) {
                    templatesGrid.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #64748b;">
                            <i class="fas fa-cog" style="font-size: 3rem; margin-bottom: 16px; display: block;"></i>
                            <div style="font-size: 1.1rem; margin-bottom: 8px;">Google Drive Not Configured</div>
                            <div style="font-size: 0.875rem; margin-bottom: 16px;">Configure your Google Drive service account to access templates</div>
                            <button type="button" class="btn btn-primary" onclick="configureDriveAccess()" style="margin-top: 16px;">
                                <i class="fas fa-cog"></i>
                                Configure Google Drive
                            </button>
                        </div>
                    `;
                } else {
                    templatesGrid.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #64748b;">
                            <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 16px; display: block;"></i>
                            <div style="font-size: 1.1rem; margin-bottom: 8px;">No templates found</div>
                            <div style="font-size: 0.875rem;">Upload PPTX or PDF templates to your Google Drive folder</div>
                            <button type="button" class="btn btn-primary" onclick="openDriveFolder()" style="margin-top: 16px;">
                                <i class="fas fa-external-link-alt"></i>
                                Open Drive Folder
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading Drive templates:', error);
                templatesGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 16px; display: block;"></i>
                        <div style="font-size: 1.1rem; margin-bottom: 8px;">Error loading templates</div>
                        <div style="font-size: 0.875rem; margin-bottom: 16px;">${error.message}</div>
                        <button type="button" class="btn btn-outline" onclick="loadDriveTemplates()">
                            <i class="fas fa-redo"></i>
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        function selectDriveTemplate(templateId, templateName) {
            selectedDriveTemplate = { id: templateId, name: templateName };
            selectedTemplateFile = null; // Clear file selection

            // Update UI to show selection
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.template-card').classList.add('selected');

            // Show certificate details section
            document.getElementById('certificateDetails').style.display = 'block';

            // Clear file upload if any
            const templateUpload = document.getElementById('templateUpload');
            templateUpload.classList.remove('has-file');
            templateUpload.innerHTML = `
                <input type="file" id="templateFile" name="template" accept=".pdf,.pptx" class="file-input">
                <div class="upload-icon">
                    <i class="fas fa-file-alt"></i>
                </div>
                <div class="upload-text">Select template file</div>
                <div class="upload-hint">Supports .pptx (recommended) and .pdf files</div>
            `;
            document.getElementById('templateFile').addEventListener('change', handleTemplateFile);

            // Update status indicator
            document.getElementById('templateStatus').textContent = `Drive: ${templateName}`;
            document.getElementById('templateStatus').className = 'status-value status-success';

            console.log('Google Drive template selected:', templateId, templateName);
        }

        // Field Mapping Functions
        async function extractExcelColumns(file) {
            try {
                console.log('Starting Excel analysis for file:', file.name);
                const formData = new FormData();
                formData.append('excel', file);

                console.log('Sending request to /analyze-excel...');
                const response = await fetch('/analyze-excel', {
                    method: 'POST',
                    body: formData
                });

                console.log('Excel analysis response status:', response.status);
                const result = await response.json();
                console.log('Excel analysis result:', result);

                if (result.success) {
                    excelColumns = result.columns;
                    console.log('Excel columns extracted:', excelColumns);
                    updateFieldMapping();
                } else {
                    console.error('Excel analysis failed:', result.error);
                }
            } catch (error) {
                console.error('Error extracting Excel columns:', error);
            }
        }

        async function analyzeTemplateFile(file) {
            try {
                console.log('Starting template analysis for file:', file.name);
                const formData = new FormData();
                formData.append('template', file);

                console.log('Sending request to /analyze-template...');
                const response = await fetch('/analyze-template', {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Analysis result:', result);

                if (result.success) {
                    detectedPlaceholders = result.placeholders;
                    console.log('Template placeholders detected:', detectedPlaceholders);
                    updateFieldMapping();
                } else {
                    console.error('Template analysis failed:', result.error);
                    showAlert('Failed to analyze template: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error analyzing template:', error);
                showAlert('Error analyzing template: ' + error.message, 'error');
            }
        }

        async function analyzeTemplate() {
            if (selectedTemplateFile) {
                analyzeTemplateFile(selectedTemplateFile);
            } else if (selectedDriveTemplate) {
                // Analyze Drive template
                try {
                    const response = await fetch(`/analyze-drive-template/${selectedDriveTemplate.id}`);
                    const result = await response.json();
                    if (result.success) {
                        detectedPlaceholders = result.placeholders;
                        console.log('Drive template placeholders detected:', detectedPlaceholders);
                        updateFieldMapping();
                    }
                } catch (error) {
                    console.error('Error analyzing Drive template:', error);
                }
            }
        }

        function updateFieldMapping() {
            console.log('updateFieldMapping called');
            console.log('detectedPlaceholders:', detectedPlaceholders, 'length:', detectedPlaceholders.length);
            console.log('excelColumns:', excelColumns, 'length:', excelColumns.length);

            if (detectedPlaceholders.length === 0 || excelColumns.length === 0) {
                console.log('Not enough data for field mapping - placeholders:', detectedPlaceholders.length, 'columns:', excelColumns.length);
                return;
            }

            console.log('Proceeding with field mapping...');
            const mappingSection = document.getElementById('fieldMappingSection');
            const mappingContainer = document.getElementById('fieldMappingContainer');

            if (!mappingSection || !mappingContainer) {
                console.error('Mapping elements not found!');
                return;
            }

            // Show the mapping section
            mappingSection.style.display = 'block';

            // Create placeholder count info
            let html = `
                <div class="placeholder-detected">
                    <span class="placeholder-count">${detectedPlaceholders.length} placeholders</span> detected in template.
                    Map them to Excel columns for automatic population.
                </div>
            `;

            // Create mapping items
            console.log('Creating mapping items for placeholders:', detectedPlaceholders);
            detectedPlaceholders.forEach(placeholder => {
                console.log('Processing placeholder:', placeholder);
                const suggestedColumn = findBestMatch(placeholder, excelColumns);
                console.log('Suggested column for', placeholder, ':', suggestedColumn);
                const isAutoMapped = suggestedColumn !== null;

                html += `
                    <div class="field-mapping-item ${isAutoMapped ? 'mapped' : ''}">
                        <input type="checkbox" class="field-mapping-checkbox"
                               id="map_${placeholder}"
                               ${isAutoMapped ? 'checked' : ''}
                               onchange="toggleFieldMapping('${placeholder}', this.checked)">
                        <div class="field-mapping-info">
                            <div class="field-mapping-placeholder">{{${placeholder}}}</div>
                            <div class="field-mapping-description">
                                ${getPlaceholderDescription(placeholder)}
                            </div>
                        </div>
                        <select class="form-select field-mapping-select"
                                id="select_${placeholder}"
                                onchange="updateSingleFieldMapping('${placeholder}', this.value)"
                                ${!isAutoMapped ? 'disabled' : ''}>
                            <option value="">Select Excel Column</option>
                            ${excelColumns.map(col =>
                    `<option value="${col}" ${col === suggestedColumn ? 'selected' : ''}>${col}</option>`
                ).join('')}
                        </select>
                        ${isAutoMapped ? `<div class="field-mapping-preview">Auto-mapped</div>` : ''}
                    </div>
                `;

                // Store initial mapping
                if (isAutoMapped) {
                    fieldMappings[placeholder] = suggestedColumn;
                }
            });

            console.log('Setting mapping container HTML:', html.length, 'characters');
            mappingContainer.innerHTML = html;
            console.log('Field mappings after creation:', fieldMappings);
        }

        function findBestMatch(placeholder, columns) {
            const lowerPlaceholder = placeholder.toLowerCase();
            console.log('Finding best match for placeholder:', placeholder, 'in columns:', columns);

            // Exact match
            for (const col of columns) {
                if (col.toLowerCase() === lowerPlaceholder) {
                    console.log('Exact match found:', col);
                    return col;
                }
            }

            // Partial match
            for (const col of columns) {
                if (col.toLowerCase().includes(lowerPlaceholder) || lowerPlaceholder.includes(col.toLowerCase())) {
                    console.log('Partial match found:', col);
                    return col;
                }
            }

            // Common mappings
            const commonMappings = {
                'name': ['name', 'full_name', 'fullname', 'student_name', 'participant'],
                'email': ['email', 'email_address', 'mail'],
                'course': ['course', 'course_name', 'subject', 'program'],
                'date': ['date', 'completion_date', 'issue_date', 'certificate_date'],
                'grade': ['grade', 'score', 'marks', 'result'],
                'id': ['id', 'student_id', 'participant_id', 'certificate_id']
            };

            for (const [key, variations] of Object.entries(commonMappings)) {
                if (variations.includes(lowerPlaceholder)) {
                    for (const col of columns) {
                        if (variations.includes(col.toLowerCase())) {
                            return col;
                        }
                    }
                }
            }

            console.log('No match found for placeholder:', placeholder);
            return null;
        }

        function getPlaceholderDescription(placeholder) {
            const descriptions = {
                'name': 'Recipient\'s full name',
                'email': 'Email address for delivery',
                'course': 'Course or program name',
                'date': 'Completion or issue date',
                'grade': 'Grade or score achieved',
                'id': 'Unique identifier',
                'organization': 'Issuing organization',
                'instructor': 'Instructor or teacher name',
                'duration': 'Course duration',
                'credits': 'Credit hours or points'
            };

            return descriptions[placeholder.toLowerCase()] || `Custom field: ${placeholder}`;
        }

        function toggleFieldMapping(placeholder, enabled) {
            const selectElement = document.getElementById(`select_${placeholder}`);
            const mappingItem = selectElement.closest('.field-mapping-item');

            selectElement.disabled = !enabled;

            if (enabled) {
                mappingItem.classList.add('mapped');
                if (selectElement.value) {
                    fieldMappings[placeholder] = selectElement.value;
                }
            } else {
                mappingItem.classList.remove('mapped');
                delete fieldMappings[placeholder];
            }

            console.log('Field mappings updated:', fieldMappings);
        }

        function updateSingleFieldMapping(placeholder, column) {
            if (column) {
                fieldMappings[placeholder] = column;
            } else {
                delete fieldMappings[placeholder];
            }
            console.log('Field mappings updated:', fieldMappings);
        }

        function previewMapping() {
            if (Object.keys(fieldMappings).length === 0) {
                showAlert('No field mappings configured', 'warning');
                return;
            }

            let preview = 'Field Mapping Preview:\n\n';
            for (const [placeholder, column] of Object.entries(fieldMappings)) {
                preview += `{{${placeholder}}} → Excel Column: "${column}"\n`;
            }

            alert(preview);
        }

        // Test function for field mapping
        function testFieldMapping() {
            console.log('Testing field mapping...');
            console.log('detectedPlaceholders:', detectedPlaceholders);
            console.log('excelColumns:', excelColumns);
            console.log('fieldMappings:', fieldMappings);

            // Set test data with your actual data
            detectedPlaceholders = ['Name', 'certificate no'];
            excelColumns = ['Name', 'Email', 'certificate no', '9'];

            console.log('Set test data with your actual values - calling updateFieldMapping()');
            updateFieldMapping();
        }

        // Google Drive helper functions
        function refreshDriveTemplates() {
            loadDriveTemplates();
            showAlert('Templates refreshed from Google Drive', 'success');
        }

        function configureDriveAccess() {
            // Open Drive configuration modal
            document.getElementById('driveConfigModal').style.display = 'block';
        }

        function openDriveFolder() {
            // This will be configured based on the Drive folder ID
            window.open('https://drive.google.com/drive/folders/YOUR_FOLDER_ID', '_blank');
        }

        function closeDriveConfig() {
            document.getElementById('driveConfigModal').style.display = 'none';
        }

        function extractEmailFromJson() {
            const jsonContent = document.getElementById('drivePrivateKey').value;
            const resultDiv = document.getElementById('driveConfigResult');

            if (!jsonContent.trim()) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please paste the service account JSON first</div>';
                return;
            }

            try {
                const serviceAccountJson = JSON.parse(jsonContent);
                if (serviceAccountJson.client_email) {
                    document.getElementById('driveServiceEmail').value = serviceAccountJson.client_email;
                    resultDiv.innerHTML = '<div class="alert alert-success">Service account email extracted successfully!</div>';
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-error">No client_email found in the JSON</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-error">Invalid JSON format</div>';
            }
        }

        async function saveDriveConfig() {
            const serviceEmail = document.getElementById('driveServiceEmail').value;
            const jsonContent = document.getElementById('drivePrivateKey').value;
            const folderId = document.getElementById('driveFolderId').value;
            const resultDiv = document.getElementById('driveConfigResult');

            if (!jsonContent || !folderId) {
                resultDiv.innerHTML = '<div class="alert alert-error">Please provide the service account JSON and folder ID</div>';
                return;
            }

            // Parse and validate JSON
            let serviceAccountJson;
            try {
                serviceAccountJson = JSON.parse(jsonContent);
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-error">Invalid JSON format. Please paste the entire service account JSON file content.</div>';
                return;
            }

            // Validate required fields
            if (!serviceAccountJson.client_email || !serviceAccountJson.private_key) {
                resultDiv.innerHTML = '<div class="alert alert-error">Invalid service account JSON. Missing client_email or private_key.</div>';
                return;
            }

            // Auto-populate service email if not provided
            const finalServiceEmail = serviceEmail || serviceAccountJson.client_email;
            document.getElementById('driveServiceEmail').value = finalServiceEmail;

            try {
                const response = await fetch('/drive/configure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        serviceAccountEmail: finalServiceEmail,
                        serviceAccountJson: serviceAccountJson,
                        folderId: folderId
                    })
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = '<div class="alert alert-success">Google Drive configured successfully!</div>';

                    // Update status indicator
                    document.getElementById('driveStatus').textContent = 'Connected';
                    document.getElementById('driveStatus').className = 'status-value status-success';

                    // Refresh templates
                    loadDriveTemplates();
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-error">${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }

        async function testDriveConnection() {
            const resultDiv = document.getElementById('driveConfigResult');

            try {
                const response = await fetch('/drive/test');
                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = `<div class="alert alert-success">Connection successful! Found ${result.templateCount} templates in folder.</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-error">Connection failed: ${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-error">Test failed: ${error.message}</div>`;
            }
        }

        // Email functionality
        function openEmailModal() {
            if (!currentBatchData) {
                showAlert('Please generate certificates first before sending emails', 'warning');
                return;
            }
            document.getElementById('emailModal').style.display = 'block';
            loadRecipients();
        }

        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
        }

        function loadRecipients() {
            if (!currentBatchData) return;

            const recipientsList = document.getElementById('recipientsList');
            let html = '<div class="section-title">Recipients with Email Addresses</div>';

            const recipients = currentBatchData.excelData.filter(item => item.email);

            if (recipients.length === 0) {
                html += '<div class="alert alert-warning">No email addresses found in the Excel file.</div>';
            } else {
                html += '<div style="display: grid; gap: 8px; margin-top: 16px;">';
                recipients.forEach(recipient => {
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;">
                            <div>
                                <div style="font-weight: 500; color: #1e293b;">${recipient.name}</div>
                                <div style="font-size: 0.875rem; color: #64748b;">${recipient.email}</div>
                            </div>
                            <i class="fas fa-check-circle" style="color: #10b981;"></i>
                        </div>
                    `;
                });
                html += '</div>';

                html += `<div style="margin-top: 16px; padding: 12px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px;">
                    <strong>Total recipients:</strong> ${recipients.length}
                </div>`;
            }

            recipientsList.innerHTML = html;
        }

        async function configureEmail() {
            const user = document.getElementById('emailUser').value;
            const pass = document.getElementById('emailPass').value;
            const configBtn = document.getElementById('configEmailBtn');
            const resultDiv = document.getElementById('emailTestResult');

            if (!user || !pass) {
                resultDiv.innerHTML = '<div class="alert alert-error">Please enter both email and password</div>';
                return;
            }

            configBtn.disabled = true;
            configBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Configuring...';

            try {
                const response = await fetch('/configure-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        service: 'gmail',
                        user: user,
                        password: pass
                    })
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = '<div class="alert alert-success">Email configured and tested successfully!</div>';
                    document.getElementById('emailPass').value = '';

                    // Update status indicator
                    document.getElementById('emailStatus').textContent = 'Configured';
                    document.getElementById('emailStatus').className = 'status-value status-success';
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-error">${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            } finally {
                configBtn.disabled = false;
                configBtn.innerHTML = '<i class="fas fa-check"></i> Configure & Test Email';
            }
        }

        async function loadEmailTemplate() {
            const template = document.getElementById('emailTemplate').value;
            const messageField = document.getElementById('emailMessage');

            if (template === 'custom') return;

            const templates = {
                completion: {
                    subject: '🎓 Certificate of Completion - {{course}}',
                    text: `Dear {{name}},

Congratulations! You have successfully completed the {{course}} course.

We are pleased to present you with your Certificate of Completion. This certificate recognizes your dedication and achievement in mastering the course material.

Course Details:
- Course: {{course}}
- Completion Date: {{date}}
- Organization: {{organization}}

Your certificate is attached to this email. Please save it for your records.

Thank you for your commitment to learning and professional development.

Best regards,
{{organization}} Team`
                },
                achievement: {
                    subject: '🏆 Achievement Certificate - {{course}}',
                    text: `Dear {{name}},

Congratulations on your outstanding achievement!

You have successfully completed the {{course}} and demonstrated exceptional skill and dedication. This achievement certificate recognizes your hard work and commitment to excellence.

Achievement Details:
- Course: {{course}}
- Date: {{date}}
- Instructor: {{instructor}}
- Organization: {{organization}}

Your certificate is attached to this email. We encourage you to share this achievement with your network and add it to your professional portfolio.

Keep up the excellent work!

Best regards,
The {{organization}} Team`
                },
                professional: {
                    subject: 'Professional Certificate - {{course}}',
                    text: `Dear {{name}},

This is to certify that you have successfully completed the {{course}} program.

Certificate Details:
- Recipient: {{name}}
- Course: {{course}}
- Date of Completion: {{date}}
- Issuing Organization: {{organization}}

This certificate validates your professional development and acquired skills in the subject matter. Please find your certificate attached to this email.

For verification purposes, please retain this certificate and email for your professional records.

Sincerely,
{{organization}}`
                }
            };

            if (templates[template]) {
                messageField.value = templates[template].text;
                document.getElementById('emailSubject').value = templates[template].subject;
            }
        }

        async function sendEmails() {
            if (!currentBatchData) {
                showAlert('No certificates available to send', 'error');
                return;
            }

            const sendBtn = document.getElementById('sendEmailBtn');
            const resultsDiv = document.getElementById('emailResults');

            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            const senderName = document.getElementById('senderName').value;

            if (!subject || !message) {
                showAlert('Please fill in email subject and message', 'error');
                return;
            }

            const recipients = currentBatchData.excelData
                .filter(item => item.email && item.email.trim())
                .map(item => {
                    const matchingFile = currentBatchData.generatedFiles.find(file =>
                        file.name === item.name
                    );
                    return {
                        name: item.name,
                        email: item.email,
                        filename: matchingFile ? matchingFile.filename : null
                    };
                })
                .filter(recipient => recipient.filename);

            if (recipients.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-error">No valid email addresses found or no matching certificates</div>';
                return;
            }

            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

            try {
                const response = await fetch('/send-certificates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        batchId: currentBatchData.batchId,
                        recipients: recipients,
                        emailConfig: {
                            subject: subject,
                            customText: message,
                            course: document.getElementById('courseField').value,
                            organization: document.getElementById('organizationField').value,
                            instructor: document.getElementById('instructorField').value,
                            date: document.getElementById('dateField').value,
                            senderName: senderName
                        }
                    })
                });

                const result = await response.json();
                showEmailResults(result);

            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-error">Error sending emails: ${error.message}</div>`;
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Certificates to All Recipients';
            }
        }

        function showEmailResults(result) {
            const resultsDiv = document.getElementById('emailResults');

            let html = `
                <div class="alert ${result.success ? 'alert-success' : 'alert-warning'}">
                    <strong>Email Results</strong><br>
                    Sent: ${result.sent || 0} | Failed: ${result.failed || 0}
                </div>
            `;

            if (result.results && result.results.length > 0) {
                html += '<div class="section-title">Successfully Sent</div>';
                html += '<div style="display: grid; gap: 8px; margin-top: 12px;">';
                result.results.forEach(res => {
                    html += `<div style="padding: 8px 12px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px; font-size: 0.875rem;">
                        ✅ ${res.name} (${res.recipient})
                    </div>`;
                });
                html += '</div>';
            }

            if (result.errors && result.errors.length > 0) {
                html += '<div class="section-title" style="margin-top: 16px;">Failed to Send</div>';
                html += '<div style="display: grid; gap: 8px; margin-top: 12px;">';
                result.errors.forEach(error => {
                    html += `<div style="padding: 8px 12px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 4px; font-size: 0.875rem;">
                        ❌ ${error.name} (${error.email}): ${error.error}
                    </div>`;
                });
                html += '</div>';
            }

            resultsDiv.innerHTML = html;
        }

        // Debug function to check file status
        function debugFiles() {
            console.log('=== DEBUG FILES ===');
            console.log('selectedExcelFile:', selectedExcelFile);
            console.log('selectedTemplateFile:', selectedTemplateFile);
            console.log('selectedDriveTemplate:', selectedDriveTemplate);

            const excelInput = document.getElementById('excelFile');
            const templateInput = document.getElementById('templateFile');

            console.log('Excel input element:', excelInput);
            console.log('Excel input files:', excelInput ? excelInput.files : 'null');
            console.log('Template input element:', templateInput);
            console.log('Template input files:', templateInput ? templateInput.files : 'null');

            alert(`Debug Info:
Excel File: ${selectedExcelFile ? selectedExcelFile.name : 'None'}
Template File: ${selectedTemplateFile ? selectedTemplateFile.name : 'None'}
Drive Template: ${selectedDriveTemplate ? selectedDriveTemplate.name : 'None'}`);
        }

        // Create test data for email testing
        async function createTestData() {
            // Show loading animation
            showLoadingOverlay(true);
            updateLoadingProgress(0, 'Creating test data...');
            updateLoadingStep(1, 'active');

            // Simulate processing steps
            await new Promise(resolve => setTimeout(resolve, 500));
            updateLoadingProgress(25, 'Generating test certificates...');
            updateLoadingStep(1, 'completed');
            updateLoadingStep(2, 'active');

            await new Promise(resolve => setTimeout(resolve, 600));
            updateLoadingProgress(50, 'Processing test recipients...');
            updateLoadingStep(2, 'completed');
            updateLoadingStep(3, 'active');

            await new Promise(resolve => setTimeout(resolve, 400));
            updateLoadingProgress(75, 'Finalizing test data...');
            updateLoadingStep(3, 'completed');
            updateLoadingStep(4, 'active');

            // Create mock batch data for testing email functionality
            currentBatchData = {
                batchId: 'test-batch-' + Date.now(),
                generatedFiles: [
                    { name: 'John Smith', filename: 'john-smith-cert.pdf' },
                    { name: 'Jane Doe', filename: 'jane-doe-cert.pdf' },
                    { name: 'Mike Johnson', filename: 'mike-johnson-cert.pdf' },
                    { name: 'Sarah Wilson', filename: 'sarah-wilson-cert.pdf' },
                    { name: 'David Brown', filename: 'david-brown-cert.pdf' },
                    { name: 'Emily Davis', filename: 'emily-davis-cert.pdf' },
                    { name: 'Christopher Lee with a Very Long Name That Should Be Truncated', filename: 'christopher-lee-cert.pdf' }
                ],
                excelData: [
                    { name: 'John Smith', email: 'john.smith@example.com' },
                    { name: 'Jane Doe', email: 'jane.doe@example.com' },
                    { name: 'Mike Johnson', email: 'mike.johnson@example.com' },
                    { name: 'Sarah Wilson', email: 'sarah.wilson@example.com' },
                    { name: 'David Brown', email: 'david.brown@example.com' },
                    { name: 'Emily Davis', email: 'emily.davis@example.com' },
                    { name: 'Christopher Lee with a Very Long Name That Should Be Truncated', email: 'christopher.lee@example.com' }
                ],
                hasEmails: true
            };

            await new Promise(resolve => setTimeout(resolve, 500));
            updateLoadingProgress(100, 'Test data created successfully!');
            updateLoadingStep(4, 'completed');
            updateLoadingStep(5, 'active');

            await new Promise(resolve => setTimeout(resolve, 600));
            updateLoadingStep(5, 'completed');

            // Hide loading and show results
            showLoadingOverlay(false);
            showResults(currentBatchData);
            showAlert('Test data created! You can now test email functionality.', 'success');
        }

        // Show all certificates function
        function showAllCertificates() {
            if (!currentBatchData) return;

            const certificatesList = document.getElementById('certificatesList');
            const result = currentBatchData;

            // Build complete certificates list
            let html = '<div style="display: grid; gap: 12px;">';

            result.generatedFiles.forEach(file => {
                html += `
                    <div class="certificate-item">
                        <div class="certificate-info">
                            <div class="certificate-name">${file.name}</div>
                            <div class="certificate-status">Certificate generated</div>
                        </div>
                        <a href="/download/${result.batchId}/${file.filename}" class="btn btn-outline" target="_blank">
                            <i class="fas fa-download"></i>
                            Download
                        </a>
                    </div>
                `;
            });

            // Add collapse button
            html += `
                <div class="certificate-item remaining-certificates">
                    <div class="certificate-info">
                        <div class="certificate-name">Showing all ${result.generatedFiles.length} certificates</div>
                        <div class="certificate-status">Click to collapse view</div>
                    </div>
                    <button type="button" class="btn btn-outline" onclick="showResults(currentBatchData)">
                        <i class="fas fa-compress-alt"></i>
                        Collapse
                    </button>
                </div>
            `;

            html += '</div>';

            // Add summary info
            html += `
                <div style="margin-top: 16px; padding: 12px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px;">
                    <strong>Generation Complete:</strong> ${result.generatedFiles.length} certificate${result.generatedFiles.length > 1 ? 's' : ''} generated successfully
                </div>
            `;

            certificatesList.innerHTML = html;
        }

        async function handleFormSubmit(event) {
            event.preventDefault();

            // Debug logging
            console.log('Form submitted');
            console.log('selectedExcelFile:', selectedExcelFile);
            console.log('selectedTemplateFile:', selectedTemplateFile);
            console.log('selectedDriveTemplate:', selectedDriveTemplate);

            // Validation using global variables
            if (!selectedExcelFile) {
                console.log('Excel file validation failed');
                showAlert('Please select an Excel file', 'error');
                return;
            }

            if (!selectedTemplateFile && !selectedDriveTemplate) {
                console.log('Template validation failed');
                showAlert('Please select a template file or choose from Google Drive templates', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('excel', selectedExcelFile);

            if (selectedTemplateFile) {
                formData.append('template', selectedTemplateFile);
                console.log('Using template file:', selectedTemplateFile.name);
            } else if (selectedDriveTemplate) {
                formData.append('driveTemplate', JSON.stringify(selectedDriveTemplate));
                console.log('Using Google Drive template:', selectedDriveTemplate);
            }

            // Add certificate details
            const course = document.getElementById('courseField').value;
            const instructor = document.getElementById('instructorField').value;
            const organization = document.getElementById('organizationField').value;
            const date = document.getElementById('dateField').value;

            if (course) formData.append('course', course);
            if (instructor) formData.append('instructor', instructor);
            if (organization) formData.append('organization', organization);
            if (date) formData.append('date', date);

            // Add field mappings if available
            if (Object.keys(fieldMappings).length > 0) {
                formData.append('fieldMappings', JSON.stringify(fieldMappings));
                console.log('Including field mappings:', fieldMappings);
            }

            // Show loading overlay
            showLoadingOverlay(true);
            updateLoadingProgress(0, 'Initializing...');
            updateLoadingStep(1, 'active');

            try {
                // Simulate upload progress
                updateLoadingProgress(10, 'Uploading files...');
                await new Promise(resolve => setTimeout(resolve, 500));

                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                updateLoadingProgress(30, 'Files uploaded successfully');
                updateLoadingStep(1, 'completed');
                updateLoadingStep(2, 'active');
                await new Promise(resolve => setTimeout(resolve, 300));

                updateLoadingProgress(50, 'Processing Excel data...');
                updateLoadingStep(2, 'completed');
                updateLoadingStep(3, 'active');
                await new Promise(resolve => setTimeout(resolve, 400));

                updateLoadingProgress(70, 'Generating certificates...');
                updateLoadingStep(3, 'completed');
                updateLoadingStep(4, 'active');

                const result = await response.json();

                if (result.success) {
                    updateLoadingProgress(90, 'Finalizing certificates...');
                    updateLoadingStep(4, 'completed');
                    updateLoadingStep(5, 'active');
                    await new Promise(resolve => setTimeout(resolve, 500));

                    updateLoadingProgress(100, 'Certificates generated successfully!');
                    updateLoadingStep(5, 'completed');
                    await new Promise(resolve => setTimeout(resolve, 800));

                    showLoadingOverlay(false);
                    showResults(result);
                } else {
                    showLoadingOverlay(false);
                    showAlert(result.error || 'An error occurred', 'error');
                }
            } catch (error) {
                showLoadingOverlay(false);
                showAlert('Network error: ' + error.message, 'error');
            }
        }

        // Email Configuration Functions
        function openEmailConfig() {
            document.getElementById('emailConfigModal').style.display = 'block';
        }

        function closeEmailConfig() {
            document.getElementById('emailConfigModal').style.display = 'none';
        }

        async function saveEmailConfig() {
            const provider = document.getElementById('emailProvider').value;
            const user = document.getElementById('configEmailUser').value;
            const pass = document.getElementById('configEmailPass').value;
            const resultDiv = document.getElementById('emailConfigResult');

            if (!user || !pass) {
                resultDiv.innerHTML = '<div class="alert alert-error">Please enter both email and password</div>';
                return;
            }

            try {
                const response = await fetch('/configure-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        service: provider,
                        user: user,
                        password: pass
                    })
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = '<div class="alert alert-success">Email configuration saved successfully!</div>';
                    document.getElementById('emailStatus').textContent = 'Configured';
                    document.getElementById('emailStatus').className = 'status-value status-success';

                    // Clear password field
                    document.getElementById('configEmailPass').value = '';
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-error">${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }

        async function testEmailConfig() {
            const resultDiv = document.getElementById('emailConfigResult');
            resultDiv.innerHTML = '<div class="alert alert-info">Testing email configuration...</div>';

            try {
                const response = await fetch('/test-email');
                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = '<div class="alert alert-success">Email test successful!</div>';
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-error">Email test failed: ${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-error">Error testing email: ${error.message}</div>`;
            }
        }

        function showProgress(show) {
            document.getElementById('progressSection').style.display = show ? 'block' : 'none';
            if (!show) {
                updateProgress(0, 'Ready');
            }
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // Loading overlay functions
        function showLoadingOverlay(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.style.display = 'flex';
                // Reset all steps
                document.querySelectorAll('.loading-step').forEach(step => {
                    step.classList.remove('active', 'completed');
                });
                // Disable form submission
                document.getElementById('generateBtn').disabled = true;
            } else {
                overlay.style.display = 'none';
                // Re-enable form submission
                document.getElementById('generateBtn').disabled = false;
            }
        }

        function updateLoadingProgress(percent, text) {
            document.getElementById('loadingProgressFill').style.width = percent + '%';
            document.getElementById('loadingProgressText').textContent = `${percent}%`;
            if (text) {
                document.getElementById('loadingSubtitle').textContent = text;
            }
        }

        function updateLoadingStep(stepNumber, status) {
            const step = document.getElementById(`step${stepNumber}`);
            if (!step) return;

            // Remove all status classes
            step.classList.remove('active', 'completed');

            // Add new status
            if (status) {
                step.classList.add(status);
            }

            // Update icon based on status
            const icon = step.querySelector('.loading-step-icon i');
            if (status === 'completed') {
                icon.className = 'fas fa-check';
            } else if (status === 'active') {
                icon.className = 'fas fa-spinner fa-spin';
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `<strong>${type === 'success' ? 'Success' : type === 'error' ? 'Error' : 'Info'}:</strong> ${message}`;

            // Insert at the top of the app container
            const appContainer = document.querySelector('.app-container');
            appContainer.insertBefore(alertDiv, appContainer.firstChild);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function showResults(result) {
            currentBatchData = result;
            const resultsSection = document.getElementById('resultsSection');
            const certificatesList = document.getElementById('certificatesList');

            const totalFiles = result.generatedFiles.length;
            const maxVisible = 3;
            const filesToShow = result.generatedFiles.slice(0, maxVisible);
            const remainingCount = totalFiles - maxVisible;

            // Build certificates list
            let html = '<div style="display: grid; gap: 12px;">';

            filesToShow.forEach(file => {
                html += `
                    <div class="certificate-item">
                        <div class="certificate-info">
                            <div class="certificate-name">${file.name}</div>
                            <div class="certificate-status">Certificate generated</div>
                        </div>
                        <a href="/download/${result.batchId}/${file.filename}" class="btn btn-outline" target="_blank">
                            <i class="fas fa-download"></i>
                            Download
                        </a>
                    </div>
                `;
            });

            // Show remaining count if there are more certificates
            if (remainingCount > 0) {
                html += `
                    <div class="certificate-item remaining-certificates">
                        <div class="certificate-info">
                            <div class="certificate-name">+ ${remainingCount} more certificate${remainingCount > 1 ? 's' : ''}</div>
                            <div class="certificate-status">Click to view all certificates</div>
                        </div>
                        <button type="button" class="btn btn-outline" onclick="showAllCertificates()">
                            <i class="fas fa-list"></i>
                            View All
                        </button>
                    </div>
                `;
            }

            html += '</div>';

            // Add summary info
            html += `
                <div style="margin-top: 16px; padding: 12px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px;">
                    <strong>Generation Complete:</strong> ${totalFiles} certificate${totalFiles > 1 ? 's' : ''} generated successfully
                </div>
            `;

            certificatesList.innerHTML = html;
            resultsSection.style.display = 'block';

            // Show email option if emails are available
            if (result.hasEmails) {
                document.getElementById('emailAvailable').style.display = 'block';
            }

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        async function checkSystemStatus() {
            try {
                // Check email status
                const emailResponse = await fetch('/email-status');
                const emailStatus = await emailResponse.json();

                document.getElementById('emailStatus').textContent = emailStatus.configured ? 'Configured' : 'Not configured';
                document.getElementById('emailStatus').className = `status-value ${emailStatus.configured ? 'status-success' : 'status-error'}`;

                // Check PPTX support
                const pptxResponse = await fetch('/check-pptx-support');
                const pptxStatus = await pptxResponse.json();

                document.getElementById('pptxStatus').textContent = pptxStatus.available ? 'Available' : 'Not available';
                document.getElementById('pptxStatus').className = `status-value ${pptxStatus.available ? 'status-success' : 'status-error'}`;

                // Check Google Drive status
                const driveResponse = await fetch('/drive/status');
                const driveStatus = await driveResponse.json();

                document.getElementById('driveStatus').textContent = driveStatus.configured ? 'Connected' : 'Not configured';
                document.getElementById('driveStatus').className = `status-value ${driveStatus.configured ? 'status-success' : 'status-error'}`;

            } catch (error) {
                console.error('Error checking system status:', error);
            }
        }

        // Email functionality
        function openEmailModal() {
            document.getElementById('emailModal').style.display = 'block';
            loadRecipients();
        }

        function closeEmailModal() {
            document.getElementById('emailModal').style.display = 'none';
        }

        function loadRecipients() {
            if (!currentBatchData) return;

            const recipientsList = document.getElementById('recipientsList');
            let html = '<h4>Recipients with Email Addresses</h4>';

            const recipients = currentBatchData.excelData.filter(item => item.email);

            html += '<div style="display: grid; gap: 10px; margin-top: 15px;">';
            recipients.forEach(recipient => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <div>
                            <strong>${recipient.name}</strong>
                            <br><small>${recipient.email}</small>
                        </div>
                        <i class="fas fa-check-circle" style="color: #28a745;"></i>
                    </div>
                `;
            });
            html += '</div>';

            html += `<p style="margin-top: 15px;"><strong>Total recipients:</strong> ${recipients.length}</p>`;
            recipientsList.innerHTML = html;
        }

        async function configureEmail() {
            const user = document.getElementById('emailUser').value;
            const pass = document.getElementById('emailPass').value;
            const configBtn = document.getElementById('configEmailBtn');
            const resultDiv = document.getElementById('emailTestResult');

            if (!user || !pass) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Please enter both email and password</div>';
                return;
            }

            configBtn.disabled = true;
            configBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Configuring...';

            try {
                const response = await fetch('/configure-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        service: 'gmail',
                        user: user,
                        password: pass
                    })
                });

                const result = await response.json();

                if (result.success) {
                    resultDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Email configured and tested successfully!</div>';
                    document.getElementById('emailPass').value = '';
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> ${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Error: ${error.message}</div>`;
            } finally {
                configBtn.disabled = false;
                configBtn.innerHTML = '<i class="fas fa-check"></i> Configure & Test Email';
            }
        }

        async function loadEmailTemplate() {
            const template = document.getElementById('emailTemplate').value;
            const messageField = document.getElementById('emailMessage');

            if (template === 'custom') return;

            try {
                const response = await fetch('/email-templates');
                const result = await response.json();

                if (result.success && result.templates[template]) {
                    messageField.value = result.templates[template].text;
                    document.getElementById('emailSubject').value = result.templates[template].subject;
                }
            } catch (error) {
                console.error('Error loading email template:', error);
            }
        }

        async function sendEmails() {
            if (!currentBatchData) return;

            const sendBtn = document.getElementById('sendEmailBtn');
            const resultsDiv = document.getElementById('emailResults');

            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            const senderName = document.getElementById('senderName').value;

            const recipients = currentBatchData.excelData
                .filter(item => item.email && item.email.trim())
                .map(item => {
                    const matchingFile = currentBatchData.generatedFiles.find(file =>
                        file.name === item.name
                    );
                    return {
                        name: item.name,
                        email: item.email,
                        filename: matchingFile ? matchingFile.filename : null
                    };
                })
                .filter(recipient => recipient.filename);

            if (recipients.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-danger">No valid email addresses found or no matching certificates</div>';
                return;
            }

            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

            try {
                const response = await fetch('/send-certificates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        batchId: currentBatchData.batchId,
                        recipients: recipients,
                        emailConfig: {
                            subject: subject,
                            customText: message,
                            course: document.getElementById('courseField').value,
                            organization: document.getElementById('organizationField').value,
                            senderName: senderName
                        }
                    })
                });

                const result = await response.json();
                showEmailResults(result);

            } catch (error) {
                resultsDiv.innerHTML = `<div class="alert alert-danger">Error sending emails: ${error.message}</div>`;
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Certificates to All Recipients';
            }
        }

        function showEmailResults(result) {
            const resultsDiv = document.getElementById('emailResults');

            let html = `
                <div class="alert ${result.success ? 'alert-success' : 'alert-warning'}">
                    <h4><i class="fas fa-envelope"></i> Email Results</h4>
                    <p><strong>Sent:</strong> ${result.sent} | <strong>Failed:</strong> ${result.failed}</p>
                </div>
            `;

            if (result.results && result.results.length > 0) {
                html += '<h5>Successfully Sent:</h5><div style="display: grid; gap: 5px;">';
                result.results.forEach(res => {
                    html += `<div style="padding: 8px; background: #d4edda; border-radius: 4px;">✅ ${res.name} (${res.recipient})</div>`;
                });
                html += '</div>';
            }

            if (result.errors && result.errors.length > 0) {
                html += '<h5 style="margin-top: 15px;">Failed to Send:</h5><div style="display: grid; gap: 5px;">';
                result.errors.forEach(error => {
                    html += `<div style="padding: 8px; background: #f8d7da; border-radius: 4px;">❌ ${error.name} (${error.email}): ${error.error}</div>`;
                });
                html += '</div>';
            }

            resultsDiv.innerHTML = html;
        }
    </script>
</body>

</html>